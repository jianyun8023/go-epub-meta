# etree è¿ç§»æŠ¥å‘Š

**è¿ç§»æ—¥æœŸ**: 2025-01-06  
**æ–¹æ¡ˆ**: ä» `encoding/xml` è¿ç§»åˆ° `github.com/beevik/etree`

---

## ğŸ“Š è¿ç§»ç»“æœ

### æˆåŠŸç‡å¯¹æ¯”

| ç‰ˆæœ¬ | XML åº“ | æˆåŠŸæ•° | å¤±è´¥æ•° | æˆåŠŸç‡ | ä¾èµ– |
|------|--------|--------|--------|--------|------|
| **v0.3** | encoding/xml | 9,986 | 14 | 99.86% | âœ… é›¶ä¾èµ– |
| **v0.4** | encoding/xml + é¢„å¤„ç† | 9,996 | 4 | 99.96% | âœ… é›¶ä¾èµ– |
| **v0.5** | **beevik/etree + é¢„å¤„ç†** | **9,996** | **4** | **99.96%** | âŒ æœ‰ä¾èµ– |

### ç»“è®º
- âœ… æˆåŠŸç‡ä¿æŒ **99.96%**ï¼ˆä¸é¢„å¤„ç†æ–¹æ¡ˆç›¸åŒï¼‰
- âœ… ä»£ç æ›´ç®€æ´æ˜“ç»´æŠ¤
- âœ… æ›´å¼ºçš„å®¹é”™èƒ½åŠ›
- âŒ å¼•å…¥äº†å¤–éƒ¨ä¾èµ–

---

## ğŸ”§ æŠ€æœ¯å˜æ›´

### 1. æ·»åŠ ä¾èµ–

**go.mod å˜æ›´**:
```diff
module golibri

go 1.24

require (
+   github.com/beevik/etree v1.6.0
    github.com/spf13/cobra v1.8.1
)
```

### 2. è§£æå™¨æ›¿æ¢

**ä¹‹å‰** (`encoding/xml`):
```go
d := xml.NewDecoder(f)
d.Strict = false
d.CharsetReader = charsetReader

var pkg Package
if err := d.Decode(&pkg); err != nil {
    // Error handling
}
```

**ä¹‹å** (`etree`):
```go
doc := etree.NewDocument()
doc.ReadSettings.CharsetReader = charsetReader
if err := doc.ReadFromBytes(data); err != nil {
    return err
}

pkg, err := parsePackageFromEtree(doc)
```

### 3. æ–°å¢è½¬æ¢å‡½æ•°

æ·»åŠ äº†ä»¥ä¸‹è¾…åŠ©å‡½æ•°å°† etree æ–‡æ¡£è½¬æ¢ä¸º Package ç»“æ„ï¼š
- `parsePackageFromEtree()` - ä¸»è½¬æ¢å‡½æ•°
- `parseMetadataFromEtree()` - è§£æå…ƒæ•°æ®
- `parseManifestFromEtree()` - è§£ææ¸…å•
- `parseSpineFromEtree()` - è§£æè„ŠæŸ±
- `parseGuideFromEtree()` - è§£ææŒ‡å—

---

## âœ¨ ä¼˜åŠ¿åˆ†æ

### 1. **æ›´å¼ºçš„å®¹é”™æ€§**
etree å¯¹ç•¸å½¢ XML çš„å®¹å¿åº¦æ›´é«˜ï¼š
- âœ… è‡ªåŠ¨å¤„ç†å‘½åç©ºé—´é—®é¢˜
- âœ… æ›´çµæ´»çš„å±æ€§è§£æ
- âœ… å¤„ç†ä¸è§„èŒƒçš„ XML ç»“æ„

### 2. **æ›´ç®€æ´çš„ä»£ç **
```go
// etree æ–¹å¼ - ç›´è§‚æ˜“è¯»
title := elem.SelectElement("title")
value := title.Text()
id := title.SelectAttrValue("id", "")

// vs encoding/xml æ–¹å¼ - éœ€è¦å®šä¹‰å¤æ‚ç»“æ„ä½“
type SimpleMeta struct {
    Value string `xml:",chardata"`
    ID    string `xml:"id,attr,omitempty"`
    // ... æ›´å¤šæ ‡ç­¾å®šä¹‰
}
```

### 3. **æ›´çµæ´»çš„æŸ¥è¯¢**
```go
// XPath é£æ ¼æŸ¥è¯¢
titles := elem.SelectElements("title")
firstTitle := elem.FindElement("//metadata/title")
```

### 4. **æ›´å¥½çš„å¯ç»´æŠ¤æ€§**
- å‡å°‘äº†å¤æ‚çš„ç»“æ„ä½“æ ‡ç­¾å®šä¹‰
- æ›´å®¹æ˜“ç†è§£å’Œä¿®æ”¹
- è°ƒè¯•æ›´å‹å¥½

---

## âš ï¸ åŠ£åŠ¿åˆ†æ

### 1. **å¼•å…¥å¤–éƒ¨ä¾èµ–**
- ä¸å†æ˜¯"é›¶ä¾èµ–"æ ¸å¿ƒåº“
- éœ€è¦ä¿¡ä»»ç¬¬ä¸‰æ–¹åº“çš„è´¨é‡å’Œç»´æŠ¤

### 2. **æ€§èƒ½è½»å¾®ä¸‹é™**
è™½ç„¶ etree æ€§èƒ½ä¼˜ç§€ï¼Œä½†ç†è®ºä¸Šï¼š
- DOM é£æ ¼è§£æéœ€è¦åŠ è½½æ•´ä¸ªæ–‡æ¡£åˆ°å†…å­˜
- æ¯”æµå¼è§£æç¨æ…¢ï¼ˆä½†å¯¹ EPUB åœºæ™¯å½±å“å¾ˆå°ï¼‰

### 3. **ä¾èµ–é£é™©**
- ç¬¬ä¸‰æ–¹åº“å¯èƒ½åœæ­¢ç»´æŠ¤
- æœªæ¥å¯èƒ½å‡ºç°å…¼å®¹æ€§é—®é¢˜

---

## ğŸ“ˆ æµ‹è¯•ç»“æœè¯¦æƒ…

### ä»ç„¶å¤±è´¥çš„ 4 ä¸ªæ–‡ä»¶

æ‰€æœ‰å¤±è´¥éƒ½æ˜¯ **ZIP æ ¼å¼é—®é¢˜**ï¼ˆGo æ ‡å‡†åº“é™åˆ¶ï¼‰ï¼š

```
[FAIL] 255363.epub: failed to open zip reader: zip: not a valid zip file
[FAIL] 268984.epub: failed to open zip reader: zip: not a valid zip file
[FAIL] 272110.epub: failed to open zip reader: zip: not a valid zip file
[FAIL] 272111.epub: failed to open zip reader: zip: not a valid zip file
```

**è¯´æ˜**:
- è¿™äº›æ–‡ä»¶åœ¨ ebook-meta (Calibre) ä¸­éƒ½èƒ½æ­£å¸¸æ‰“å¼€
- é—®é¢˜ä¸åœ¨ XML è§£æï¼Œè€Œåœ¨ ZIP è¯»å–
- æ˜¯ Go `archive/zip` åŒ…è¿‡äºä¸¥æ ¼å¯¼è‡´çš„

### XML é—®é¢˜å®Œå…¨è§£å†³

æ‰€æœ‰ä¹‹å‰çš„ XML ç›¸å…³é—®é¢˜éƒ½å·²è§£å†³ï¼š
- âœ… XML æ³¨é‡Š `--` é—®é¢˜ï¼ˆ11 ä¸ªæ–‡ä»¶ï¼‰
- âœ… å‘½åç©ºé—´æ‹¼å†™é”™è¯¯ï¼ˆ1 ä¸ªæ–‡ä»¶ï¼‰
- âœ… å…¶ä»– XML ç»“æ„é—®é¢˜

---

## ğŸ¯ å»ºè®®

### å¯¹äºæ ¸å¿ƒåº“é›¶ä¾èµ–éœ€æ±‚

å¦‚æœ**å¿…é¡»ä¿æŒé›¶ä¾èµ–**ï¼Œå»ºè®®ï¼š
1. å›é€€åˆ° v0.4ï¼ˆencoding/xml + é¢„å¤„ç†ï¼‰
2. æˆåŠŸç‡ç›¸åŒï¼ˆ99.96%ï¼‰
3. ä»…åœ¨ç¡®å®éœ€è¦æ›´å¼ºåŠŸèƒ½æ—¶ä½¿ç”¨ etree

### å¯¹äºå®é™…ä½¿ç”¨

**æ¨èä½¿ç”¨ etree ç‰ˆæœ¬**ï¼Œç†ç”±ï¼š
1. âœ… æˆåŠŸç‡ç›¸åŒ
2. âœ… ä»£ç æ›´ç®€æ´
3. âœ… æ›´å®¹æ˜“ç»´æŠ¤å’Œæ‰©å±•
4. âœ… etree æ˜¯æˆç†Ÿç¨³å®šçš„åº“
5. âœ… æœªæ¥å¯èƒ½éœ€è¦æ›´å¤æ‚çš„ XML æ“ä½œ

---

## ğŸ”„ å›é€€æ–¹æ¡ˆ

å¦‚æœéœ€è¦å›é€€åˆ°é›¶ä¾èµ–ç‰ˆæœ¬ï¼š

```bash
# 1. ç§»é™¤ etree ä¾èµ–
go get -u github.com/beevik/etree@none
go mod tidy

# 2. æ¢å¤ä¹‹å‰çš„ reader.go (v0.4)
git checkout <commit-hash> epub/reader.go

# 3. é‡æ–°ç¼–è¯‘
go build -o golibri ./cmd/golibri
```

---

## ğŸ“š etree åº“ä¿¡æ¯

**é¡¹ç›®**: https://github.com/beevik/etree  
**ç‰ˆæœ¬**: v1.6.0  
**è®¸å¯è¯**: BSD-2-Clause  
**Star**: 1.2k+  
**æœ€åæ›´æ–°**: æ´»è·ƒç»´æŠ¤ä¸­  
**ä¾èµ–**: é›¶ä¾èµ–ï¼ˆçº¯ Goï¼‰

**ç‰¹æ€§**:
- DOM é£æ ¼ API
- XPath æ”¯æŒ
- å‘½åç©ºé—´å¤„ç†
- ç¼–ç è‡ªåŠ¨æ£€æµ‹
- æµå¼è¯»å†™æ”¯æŒ

---

## ğŸš€ ä¸‹ä¸€æ­¥ä¼˜åŒ–

### å¯é€‰ä¼˜åŒ–é¡¹

1. **ZIP å®¹é”™**ï¼ˆè§£å†³å‰©ä½™ 4 ä¸ªå¤±è´¥ï¼‰
   - è€ƒè™‘ä½¿ç”¨æ›´å®½æ¾çš„ ZIP åº“
   - æˆ–æ·»åŠ  ZIP ä¿®å¤å·¥å…·

2. **æ€§èƒ½ä¼˜åŒ–**
   - æ·»åŠ ç¼“å­˜æœºåˆ¶
   - å¹¶å‘è§£ææ”¯æŒ

3. **åŠŸèƒ½å¢å¼º**
   - åˆ©ç”¨ etree çš„ XPath èƒ½åŠ›
   - æ”¯æŒæ›´å¤æ‚çš„å…ƒæ•°æ®æŸ¥è¯¢

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

```bash
$ cloc epub/
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Language     files     blank   comment      code
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Go              8       282       178      1547
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

**å˜æ›´**:
- æ–°å¢ä»£ç : +200 è¡Œï¼ˆetree è½¬æ¢å‡½æ•°ï¼‰
- åˆ é™¤ä»£ç : -50 è¡Œï¼ˆç®€åŒ–çš„è§£æé€»è¾‘ï¼‰
- å‡€å¢åŠ : +150 è¡Œ

---

## âœ… æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•
```bash
$ go test ./epub/
PASS
ok      golibri/epub    0.523s
```

### å®¡è®¡æµ‹è¯•
```bash
$ golibri audit /path/to/10000/epubs
Scan complete. Success: 9996, Failed: 4
Success Rate: 99.96%
```

### åŠŸèƒ½æµ‹è¯•
- âœ… è¯»å–å…ƒæ•°æ®
- âœ… ä¿®æ”¹å…ƒæ•°æ®
- âœ… ä¿å­˜ EPUB
- âœ… å°é¢æ“ä½œ
- âœ… Identifier æ”¯æŒï¼ˆISBN/ASIN/è‡ªå®šä¹‰ï¼‰

---

**è¿ç§»å®Œæˆæ—¶é—´**: 2025-01-06  
**è¿ç§»çŠ¶æ€**: âœ… æˆåŠŸ  
**å»ºè®®**: æ¨èä½¿ç”¨ etree ç‰ˆæœ¬

